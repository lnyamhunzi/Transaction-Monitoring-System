{% extends "base.html" %}

{% block title %}Administration {% endblock %}

{% block page_title %}System Administration{% endblock %}

{% block content %}
<!-- Admin Loading Indicator -->
<div id="adminLoader" class="d-none alert alert-info">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span>Processing...</span>
    </div>
</div>

<!-- Admin Notifications -->
<div id="adminNotifications"></div>

<!-- System Status Overview -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>
                    System Health Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="health-component">
                            <div class="health-indicator" id="database-status">
                                <div class="status-dot status-healthy"></div>
                                <span class="status-text">Checking...</span>
                            </div>
                            <div class="component-label">Database</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="health-component">
                            <div class="health-indicator" id="ml-engine-status">
                                <div class="status-dot status-healthy"></div>
                                <span class="status-text">Checking...</span>
                            </div>
                            <div class="component-label">ML Engine</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="health-component">
                            <div class="health-indicator" id="websocket-status">
                                <div class="status-dot status-healthy"></div>
                                <span class="status-text">Checking...</span>
                            </div>
                            <div class="component-label">Real-time Service</div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="health-component">
                            <div class="health-indicator" id="email-service-status">
                                <div class="status-dot status-healthy"></div>
                                <span class="status-text">Checking...</span>
                            </div>
                            <div class="component-label">Email Service</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="cpu-usage">0%</div>
            <div class="metric-label">CPU Usage</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="memory-usage">0%</div>
            <div class="metric-label">Memory Usage</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="disk-usage">0%</div>
            <div class="metric-label">Disk Usage</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="active-connections">0</div>
            <div class="metric-label">Active Connections</div>
        </div>
    </div>
</div>

<!-- Processing Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="transactions-processed">0</div>
            <div class="metric-label">Transactions Processed</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="alerts-generated">0</div>
            <div class="metric-label">Alerts Generated</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="cases-opened">0</div>
            <div class="metric-label">Cases Opened</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value" id="ml-predictions">0</div>
            <div class="metric-label">ML Predictions</div>
        </div>
    </div>
</div>



<!-- Recent Transactions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Recent Transactions
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="recentTransactionsTable">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Customer ID</th>
                    <th>Amount</th>
                    <th>Currency</th>
                    <th>Type</th>
                    <th>Channel</th>
                    <th>Risk Score</th>
                    <th>Status</th>
                    <th>Timestamp</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Alerts -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>
                    Recent Alerts
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Risk Score</th>
                                <th>Status</th>
                                <th>Description</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in alerts %}
                            <tr>
                                <td>{{ alert.id[:8] }}...</td>
                                <td>{{ alert.alert_type }}</td>
                                <td><span class="badge bg-{{ alert.risk_score | risklevel }}">{{ alert.risk_score }}</span></td>
                                <td>{{ alert.status }}</td>
                                <td>{{ alert.description }}</td>
                                <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">No recent alerts found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Tabs -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                    {% if user.role == 'admin' %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-pane" type="button" role="tab">
                            <i class="fas fa-cog me-2"></i>Configuration
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-pane" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>User Management
                        </button>
                    </li>
                    {% endif %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ml-tab" data-bs-toggle="tab" data-bs-target="#ml-pane" type="button" role="tab">
                            <i class="fas fa-brain me-2"></i>ML Models
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sanctions-tab" data-bs-toggle="tab" data-bs-target="#sanctions-pane" type="button" role="tab">
                            <i class="fas fa-ban me-2"></i>Sanctions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-pane" type="button" role="tab">
                            <i class="fas fa-tools me-2"></i>System
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="adminTabContent">
                    <!-- Configuration Tab -->
                    <div class="tab-pane fade {% if user.role == 'admin' %}show active{% endif %}" id="config-pane" role="tabpanel">
                        <form id="configurationForm">
                            <h6 class="mb-3">Risk Thresholds</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Low Risk Threshold</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="risk-threshold-low" name="risk_threshold_low" min="0" max="1" step="0.01" value="0.3">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Medium Risk Threshold</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="risk-threshold-medium" name="risk_threshold_medium" min="0" max="1" step="0.01" value="0.6">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">High Risk Threshold</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="risk-threshold-high" name="risk_threshold_high" min="0" max="1" step="0.01" value="0.8">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="mb-3">Transaction Limits (USD)</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Low Risk Limit</label>
                                    <input type="number" class="form-control" id="limit-usd-low" name="limit_usd_low" value="1000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Medium Risk Limit</label>
                                    <input type="number" class="form-control" id="limit-usd-medium" name="limit_usd_medium" value="10000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">High Risk Limit</label>
                                    <input type="number" class="form-control" id="limit-usd-high" name="limit_usd_high" value="50000">
                                </div>
                            </div>
                            
                            <h6 class="mb-3">Notification Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="email-notifications" name="email_notifications_enabled" checked>
                                        <label class="form-check-label" for="email-notifications">
                                            Enable Email Notifications
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="sms-notifications" name="sms_notifications_enabled">
                                        <label class="form-check-label" for="sms-notifications">
                                            Enable SMS Notifications
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="mb-3">ML Settings</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="ml-enabled" name="ml_scoring_enabled" checked>
                                        <label class="form-check-label" for="ml-enabled">
                                            Enable ML Scoring
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Anomaly Threshold</label>
                                    <input type="number" class="form-control" id="anomaly-threshold" name="anomaly_threshold" min="0" max="1" step="0.01" value="0.7">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Model Retrain Interval (days)</label>
                                    <input type="number" class="form-control" id="model-retrain-interval" name="model_retrain_interval_days" value="30">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Configuration
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- User Management Tab -->
                    <div class="tab-pane fade" id="users-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">User Management</h6>
                            <button class="btn btn-primary create-user-btn">
                                <i class="fas fa-plus me-2"></i>Create User
                            </button>
                        </div>
                        
                        <div class="table-container">
                            <table class="table table-striped" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ML Models Tab -->
                    <div class="tab-pane fade {% if user.role != 'admin' %}show active{% endif %}" id="ml-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Machine Learning Models</h6>
                            <button class="btn btn-primary" id="updateModels">
                                <i class="fas fa-sync-alt me-2"></i>Retrain Models
                            </button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card" id="anomaly-detection-model-card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Anomaly Detection Model</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="model-status">
                                            <div class_="status-indicator">
                                                <div class="status-dot status-healthy"></div>
                                                <span>Active</span>
                                            </div>
                                            <div class="model-info">
                                                <p><strong>Version:</strong> 2.1.0</p>
                                                <p><strong>Accuracy:</strong> 94.2%</p>
                                                <p><strong>Last Trained:</strong> 2024-01-10</p>
                                                <p><strong>Training Data:</strong> 30 days</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card" id="risk-classification-model-card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Risk Classification Model</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="model-status">
                                            <div class="status-indicator">
                                                <div class="status-dot status-healthy"></div>
                                                <span>Active</span>
                                            </div>
                                            <div class="model-info">
                                                <p><strong>Version:</strong> 1.8.3</p>
                                                <p><strong>Accuracy:</strong> 91.7%</p>
                                                <p><strong>Last Trained:</strong> 2024-01-08</p>
                                                <p><strong>Training Data:</strong> 60 days</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sanctions Tab -->
                    <div class="tab-pane fade" id="sanctions-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Sanctions Lists Management</h6>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="updateSanctions">
                                    <i class="fas fa-sync-alt me-2"></i>Update Lists
                                </button>
                                <button class="btn btn-outline-primary" id="uploadSanctions">
                                    <i class="fas fa-upload me-2"></i>Upload Custom List
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card" id="ofac-sdn-list-card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">OFAC SDN List</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Entries:</strong> 12,547</p>
                                        <p><strong>Last Updated:</strong> 2024-01-12</p>
                                        <p><strong>Status:</strong> <span class="text-success">Active</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card" id="un-sanctions-list-card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">UN Sanctions List</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Entries:</strong> 3,241</p>
                                        <p><strong>Last Updated:</strong> 2024-01-10</p>
                                        <p><strong>Status:</strong> <span class="text-success">Active</span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card" id="pep-lists-card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">PEP Lists</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Entries:</strong> 8,932</p>
                                        <p><strong>Last Updated:</strong> 2024-01-08</p>
                                        <p><strong>Status:</strong> <span class="text-success">Active</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Tab -->
                    <div class="tab-pane fade" id="system-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">System Operations</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-warning" id="restartSystem">
                                                <i class="fas fa-power-off me-2"></i>Restart System
                                            </button>
                                            <button class="btn btn-info" id="createBackup">
                                                <i class="fas fa-database me-2"></i>Create Backup
                                            </button>
                                            <button class="btn btn-secondary" id="exportLogs">
                                                <i class="fas fa-file-export me-2"></i>Export System Logs
                                            </button>
                                            <button class="btn btn-primary" id="createAdminSelfPostingTransaction">
                                                <i class="fas fa-exchange-alt me-2"></i>Create Admin Self-Posting Transaction
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">System Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Version:</strong></td>
                                                <td>1.0.0</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Uptime:</strong></td>
                                                <td id="systemUptime">5 days, 12:34:56</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Database:</strong></td>
                                                <td>PostgreSQL 15.2</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Python:</strong></td>
                                                <td>3.11.5</td>
                                            </tr>
                                            <tr>
                                                <td><strong>FastAPI:</strong></td>
                                                <td>0.104.1</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/utils.js"></script>
<script>
$(document).ready(function() {
    var recentTransactionsTable = $('#recentTransactionsTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "/api/admin/transactions/recent", // This endpoint needs to be updated to support DataTables server-side
            "type": "GET",
            "data": function (d) {
                // DataTables sends draw, start, length, search[value], order[0][column], order[0][dir]
                // No custom filters for now, but can be added here later
            }
        },
        "columns": [
            { "data": "id", "render": function(data, type, row) { return data.substring(0, 8) + '...'; } },
            { "data": "customer_id", "render": function(data, type, row) { return data.substring(0, 8) + '...'; } },
            { 
                "data": "amount",
                "render": function ( data, type, row ) {
                    // Use AMLBase.formatCurrency if available, otherwise fallback
                    if (typeof AMLBase !== 'undefined' && AMLBase.formatCurrency) {
                        return AMLBase.formatCurrency(data, row.currency);
                    } else {
                        return `${row.currency} ${data.toFixed(2)}`;
                    }
                }
            },
            { "data": "currency" },
            { "data": "transaction_type" },
            { "data": "channel" },
            { 
                "data": "risk_score",
                "render": function ( data, type, row ) {
                    // Use AMLBase.getRiskLevel if available, otherwise fallback
                    let riskLevel = 'low';
                    if (typeof AMLBase !== 'undefined' && AMLBase.getRiskLevel) {
                        riskLevel = AMLBase.getRiskLevel(data);
                    } else if (data >= 0.9) {
                        riskLevel = 'critical';
                    } else if (data >= 0.7) {
                        riskLevel = 'high';
                    } else if (data >= 0.4) {
                        riskLevel = 'medium';
                    }
                    return `<span class="badge bg-${riskLevel}">${data}</span>`;
                }
            },
            { 
                "data": "status",
                "render": function ( data, type, row ) {
                    return `<span class="status-badge status-${data.toLowerCase()}">${data}</span>`;
                }
            },
            { 
                "data": "created_at",
                "render": function ( data, type, row ) {
                    // Data is already formatted as string from backend
                    return data;
                }
            },
            {
                "data": "status", // Use status to determine if button should be shown
                "render": function ( data, type, row ) {
                    let actionsHtml = '';
                    if (data === 'FLAGGED' || data === 'PENDING') {
                        actionsHtml = `<button class="btn btn-sm btn-success mark-complete-btn" data-transaction-id="${row.id}">Mark Complete</button>`;
                    }
                    return actionsHtml;
                }
            }
        ]
    });

    // Event listener for Mark Complete button
    $('#recentTransactionsTable tbody').on('click', '.mark-complete-btn', async function () {
        const transactionId = $(this).data('transaction-id');
        try {
            // Use AMLBase.showToast for notifications
            if (typeof AMLBase !== 'undefined' && AMLBase.showToast) {
                AMLBase.showToast('Marking transaction as complete...', 'info');
            }

            const token = await getAuthToken(); // Assuming getAuthToken is global from utils.js
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            const response = await fetch(`/api/transactions/${transactionId}/status`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'COMPLETED' })
            });

            if (response.status === 401) { window.location.href = '/admin/login'; return; }
            if (!response.ok) throw new Error('Failed to mark transaction as complete');

            const result = await response.json();
            if (typeof AMLBase !== 'undefined' && AMLBase.showToast) {
                AMLBase.showToast(result.message, 'success');
            }
            recentTransactionsTable.ajax.reload(null, false); // Reload DataTable

        } catch (error) {
            console.error('Error marking transaction as complete:', error);
            if (typeof AMLBase !== 'undefined' && AMLBase.showToast) {
                AMLBase.showToast('Failed to mark transaction as complete', 'danger');
            }
        }
    });
});
</script>
<!-- Admin Panel JavaScript -->
<script src="/static/js/admin-panel.js"></script>

<script>
// Additional admin panel functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize users table
    $('#usersTable').DataTable({
        pageLength: 25,
        responsive: true,
        order: [[0, 'asc']]
    });
    
    // Tab change handler
    const tabElements = document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]');
    tabElements.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetPane = event.target.getAttribute('data-bs-target');
            console.log('Switched to tab:', targetPane);
            
            // Resize charts when tab becomes visible
            if (targetPane === '#ml-pane') {
                // Refresh ML model status
                if (window.amlAdminPanel) {
                    window.amlAdminPanel.loadMLModelsStatus();
                }
            }
        });
    });
});
</script>
{% endblock %}