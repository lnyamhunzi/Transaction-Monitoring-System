{% extends "base.html" %}

{% block title %}Customer Monitoring{% endblock %}

{% block page_title %}Customer Monitoring{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h5 class="card-title">Customer Search and Risk Profiling</h5>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="customerSearchInput" placeholder="Search by customer name or ID">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="customerRiskRatingFilter">
                    <option value="all">All Risk Ratings</option>
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" id="applyCustomerFiltersBtn">Search</button>
            </div>
        </div>
        <table class="table table-striped" id="customersMonitoringTable">
            <thead>
                <tr>
                    <th>Customer ID</th>
                    <th>Customer Name</th>
                    <th>Risk Rating</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    var customersTable = $('#customersMonitoringTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "/api/staff/monitoring/customers",
            "type": "GET",
            "data": function (d) {
                d.search_term = $('#customerSearchInput').val();
                d.risk_rating = $('#customerRiskRatingFilter').val();
            }
        },
        "columns": [
            { "data": "customer_id" },
            { "data": "full_name" },
            { 
                "data": "risk_rating",
                "render": function ( data, type, row ) {
                    let badgeClass = "bg-secondary";
                    if (data === "LOW") badgeClass = "bg-success";
                    else if (data === "MEDIUM") badgeClass = "bg-warning";
                    else if (data === "HIGH") badgeClass = "bg-danger";
                    else if (data === "CRITICAL") badgeClass = "bg-dark";
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                "data": "last_login",
                "render": function ( data, type, row ) {
                    return data ? new Date(data).toLocaleString() : 'N/A';
                }
            },
            {
                "data": "customer_id",
                "render": function ( data, type, row ) {
                    return `<a href="/staff/customers/${data}/profile" class="btn btn-sm btn-outline-primary">View Profile</a>`;
                }
            }
        ]
    });

    $('#applyCustomerFiltersBtn').on('click', function() {
        customersTable.ajax.reload();
    });
});
</script>
{% endblock %}