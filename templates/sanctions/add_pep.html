{% extends "base.html" %}

{% block title %}Add New PEP Entry{% endblock %}

{% block page_title %}Add New PEP Entry{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h5 class="card-title">New PEP Entry</h5>
        <form id="addPEPForm">
            <div class="mb-3">
                <label for="full_name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="full_name" name="full_name" required>
            </div>
            <div class="mb-3">
                <label for="country" class="form-label">Country</label>
                <input type="text" class="form-control" id="country" name="country">
            </div>
            <div class="mb-3">
                <label for="position" class="form-label">Position</label>
                <input type="text" class="form-control" id="position" name="position">
            </div>
            <div class="mb-3">
                <label for="start_date" class="form-label">Start Date (YYYY-MM-DD)</label>
                <input type="date" class="form-control" id="start_date" name="start_date">
            </div>
            <button type="submit" class="btn btn-primary">Add Entry</button>
            <a href="/sanctions/pep" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('addPEPForm');
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'start_date') {
                    data[key] = value ? new Date(value).toISOString() : null; // Convert to ISO string or null
                } else {
                    data[key] = value;
                }
            });

            try {
                const response = await fetch('/api/pep/lists/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('PEP entry added successfully!');
                    window.location.href = '/sanctions/pep'; // Redirect back to the list
                } else {
                    const errorData = await response.json();
                    alert(`Error: ${errorData.detail || response.statusText}`);
                }
            } catch (error) {
                console.error('Error adding PEP entry:', error);
                alert('An error occurred while adding the entry.');
            }
        });
    });
</script>
{% endblock %}