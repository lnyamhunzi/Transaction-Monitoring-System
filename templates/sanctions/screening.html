{% extends "base.html" %}

{% block title %}Sanctions Screening{% endblock %}

{% block page_title %}Sanctions Screening{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Single Entity Screening</h5>
                <form id="singleScreeningForm">
                    <div class="mb-3">
                        <label for="entityName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="entityName" placeholder="Enter name">
                    </div>
                    <div class="mb-3">
                        <label for="entityCountry" class="form-label">Country</label>
                        <input type="text" class="form-control" id="entityCountry" placeholder="Enter country">
                    </div>
                    <button type="submit" class="btn btn-primary">Screen</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Bulk Screening</h5>
                <p>Upload a CSV file with names and countries for bulk screening.</p>
                <form id="bulkScreeningForm">
                    <div class="mb-3">
                        <input class="form-control" type="file" id="bulkScreeningFile">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload and Screen</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Screening Results</h5>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Country</th>
                            <th>Match Status</th>
                            <th>Sanctions/PEP Matches</th>
                            <th>Adverse Media Hits</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/utils.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('singleScreeningForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        console.log('Screening form submitted.');
        try {
            const name = document.getElementById('entityName').value;
            const country = document.getElementById('entityCountry').value;
            console.log(`Screening for: ${name}, ${country}`);

            const token = getAuthToken();
            console.log('Token:', token);
            if (!token) {
                alert('Authentication token not found. Please log in again.');
                window.location.href = '/admin/login';
                return;
            }

            const response = await fetch('/api/sanctions/screen/single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, country }),
            });
            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API request failed with status ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('API result:', result);
            displayResults([result]);
        } catch (error) {
            console.error('An error occurred during screening:', error);
            alert(`An error occurred during screening: ${error.message}`);
        }
    });

    document.getElementById('bulkScreeningForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const fileInput = document.getElementById('bulkScreeningFile');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        const token = getAuthToken();
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        const response = await fetch('/api/sanctions/screen/bulk', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData,
        });
        const results = await response.json();
        displayResults(results);
    });

    function displayResults(results) {
        console.log('displayResults called with:', results);
        const resultsBody = document.getElementById('resultsBody');
        resultsBody.innerHTML = ''; // Clear existing data

        if (!results || results.length === 0) {
            console.log('No results or empty results array.');
            resultsBody.innerHTML = '<tr><td colspan="5" class="text-center">No screening results found.</td></tr>';
            return;
        }

        console.log('Processing results:', results);
        for (const result of results) {
            console.log('Processing single result:', result);
            const row = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.textContent = result.name;
            row.appendChild(nameCell);

            const countryCell = document.createElement('td');
            countryCell.textContent = result.country || '';
            row.appendChild(countryCell);

            const statusCell = document.createElement('td');
            const hasMatch = (result.sanctions_matches && result.sanctions_matches.length > 0) || 
                             (result.pep_matches && result.pep_matches.length > 0) ||
                             (result.adverse_media_hits && result.adverse_media_hits.length > 0);
            statusCell.innerHTML = `<span class="badge bg-${hasMatch ? 'danger' : 'success'}">${hasMatch ? 'Potential Match' : 'No Match'}</span>`;
            row.appendChild(statusCell);

            const detailsCell = document.createElement('td');
            let details = '';
            if (result.sanctions_matches && result.sanctions_matches.length > 0) {
                details += 'Sanctions: ' + result.sanctions_matches.map(m => `${m.matched_name} (${m.entity_type})`).join(', ');
            }
            if (result.pep_matches && result.pep_matches.length > 0) {
                details += ' PEP: ' + result.pep_matches.map(m => `${m.matched_name}`).join(', ');
            }
            detailsCell.textContent = details || '-';
            row.appendChild(detailsCell);

            const adverseMediaCell = document.createElement('td');
            if (result.adverse_media_hits && result.adverse_media_hits.length > 0) {
                adverseMediaCell.textContent = result.adverse_media_hits.join(', ');
            } else {
                adverseMediaCell.textContent = '-';
            }
            row.appendChild(adverseMediaCell);

            resultsBody.appendChild(row);
        }
    }
});
</script>
{% endblock %}
