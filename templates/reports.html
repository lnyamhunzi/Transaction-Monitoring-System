{% extends "base.html" %}

{% block title %}Reports & Analytics{% endblock %}

{% block page_title %}AML Reports & Analytics{% endblock %}

{% block content %}
{% if user %}
<!-- Reports Header -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        AML Reporting Dashboard
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="refreshReports">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-download"></i> Generate Report
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="generateSAR">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Suspicious Activity Report
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="generateCTR">
                                    <i class="fas fa-money-bill-wave me-2"></i>Currency Transaction Report
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="generateManagementReport">
                                    <i class="fas fa-chart-line me-2"></i>Management Summary
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="generateCustomReport">
                                    <i class="fas fa-cogs me-2"></i>Custom Report
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Report Filters -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Report Period</label>
                            <select class="form-control" id="reportPeriod">
                                <option value="today">Today</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d" selected>Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" id="reportType">
                                <option value="all">All Reports</option>
                                <option value="alerts">Alerts Analysis</option>
                                <option value="transactions">Transaction Analysis</option>
                                <option value="customers">Customer Analysis</option>
                                <option value="compliance">Compliance Metrics</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Risk Level</label>
                            <select class="form-control" id="riskLevelFilter">
                                <option value="">All Risk Levels</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select class="form-control" id="currencyFilter">
                                <option value="">All Currencies</option>
                                <option value="USD">USD</option>
                                <option value="ZWL">ZWL</option>
                                <option value="ZAR">ZAR</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Date Range -->
                <div class="row" id="customReportRange" style="display: none;">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="reportStartDate">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="reportEndDate">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Executive Summary -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Executive Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="totalTransactions">0</div>
                            <div class="metric-label">Total Transactions</div>
                            <div class="metric-change" id="transactionsChange">+0%</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="totalVolume">$0</div>
                            <div class="metric-label">Total Volume</div>
                            <div class="metric-change" id="volumeChange">+0%</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="alertsGenerated">0</div>
                            <div class="metric-label">Alerts Generated</div>
                            <div class="metric-change" id="alertsChange">+0%</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="casesOpened">0</div>
                            <div class="metric-label">Cases Opened</div>
                            <div class="metric-change" id="casesChange">+0%</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="sarsFiledCount">0</div>
                            <div class="metric-label">SARs Filed</div>
                            <div class="metric-change" id="sarsChange">+0%</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="summary-metric">
                            <div class="metric-value" id="complianceScore">0%</div>
                            <div class="metric-label">Compliance Score</div>
                            <div class="metric-change" id="complianceChange">+0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Transaction Volume Trends
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="volumeTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Alert Distribution
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="alertDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Risk Score Distribution Over Time
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="riskTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-globe me-2"></i>
                    Channel Analysis
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="channelAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Reports Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="alerts-report-tab" data-bs-toggle="tab" data-bs-target="#alerts-report" type="button" role="tab">
                            <i class="fas fa-exclamation-triangle me-2"></i>Alerts Report
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-report-tab" data-bs-toggle="tab" data-bs-target="#transactions-report" type="button" role="tab">
                            <i class="fas fa-exchange-alt me-2"></i>Transactions Report
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customers-report-tab" data-bs-toggle="tab" data-bs-target="#customers-report" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Customers Report
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="compliance-report-tab" data-bs-toggle="tab" data-bs-target="#compliance-report" type="button" role="tab">
                            <i class="fas fa-shield-alt me-2"></i>Compliance Report
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="reportTabContent">
                    <!-- Alerts Report Tab -->
                    <div class="tab-pane fade show active" id="alerts-report" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Alert Summary</h6>
                                <div class="table-container">
                                    <table class="table table-sm" id="alertSummaryTable">
                                        <thead>
                                            <tr>
                                                <th>Alert Type</th>
                                                <th>Count</th>
                                                <th>Avg Risk Score</th>
                                                <th>Resolution Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Top Risk Customers</h6>
                                <div class="table-container">
                                    <table class="table table-sm" id="topRiskCustomersTable">
                                        <thead>
                                            <tr>
                                                <th>Customer ID</th>
                                                <th>Alert Count</th>
                                                <th>Max Risk Score</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transactions Report Tab -->
                    <div class="tab-pane fade" id="transactions-report" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12">
                                <h6>High-Value Transaction Analysis</h6>
                                <div class="table-container">
                                    <table class="table table-striped" id="highValueTransactionsTable">
                                        <thead>
                                            <tr>
                                                <th>Transaction ID</th>
                                                <th>Customer ID</th>
                                                <th>Amount</th>
                                                <th>Currency</th>
                                                <th>Channel</th>
                                                <th>Risk Score</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customers Report Tab -->
                    <div class="tab-pane fade" id="customers-report" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Customer Risk Profiling</h6>
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="customerRiskChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>PEP & High-Risk Customers</h6>
                                <div class="table-container">
                                    <table class="table table-sm" id="pepCustomersTable">
                                        <thead>
                                            <tr>
                                                <th>Customer ID</th>
                                                <th>Name</th>
                                                <th>Risk Rating</th>
                                                <th>PEP Status</th>
                                                <th>Last Review</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compliance Report Tab -->
                    <div class="tab-pane fade" id="compliance-report" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">SLA Compliance</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="compliance-metrics">
                                            <div class="compliance-item">
                                                <div class="compliance-label">Alert Response Time</div>
                                                <div class="compliance-value">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-success" id="alertResponseProgress" style="width: 0%"></div>
                                                    </div>
                                                    <span id="alertResponsePercentage">0%</span>
                                                </div>
                                            </div>
                                            
                                            <div class="compliance-item">
                                                <div class="compliance-label">Case Resolution Time</div>
                                                <div class="compliance-value">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-info" id="caseResolutionProgress" style="width: 0%"></div>
                                                    </div>
                                                    <span id="caseResolutionPercentage">0%</span>
                                                </div>
                                            </div>
                                            
                                            <div class="compliance-item">
                                                <div class="compliance-label">SAR Filing Timeliness</div>
                                                <div class="compliance-value">
                                                    <div class="progress">
                                                        <div class="progress-bar bg-warning" id="sarFilingProgress" style="width: 0%"></div>
                                                    </div>
                                                    <span id="sarFilingPercentage">0%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Regulatory Metrics</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <td>Total SARs Filed</td>
                                                <td id="totalSARs">0</td>
                                            </tr>
                                            <tr>
                                                <td>CTRs Filed</td>
                                                <td id="totalCTRs">0</td>
                                            </tr>
                                            <tr>
                                                <td>Sanctions Screening Coverage</td>
                                                <td id="sanctionsScreeningCoverage">100%</td>
                                            </tr>
                                            <tr>
                                                <td>False Positive Rate</td>
                                                <td id="falsePositiveRate">0%</td>
                                            </tr>
                                            <tr>
                                                <td>Alert Investigation Rate</td>
                                                <td id="alertInvestigationRate">0%</td>
                                            </tr>
                                            <tr>
                                                <td>System Uptime</td>
                                                <td id="systemUptime">99.9%</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateReportModalTitle">Generate Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="generateReportForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Report Type</label>
                                <select class="form-control" name="report_type" required>
                                    <option value="SAR">Suspicious Activity Report</option>
                                    <option value="CTR">Currency Transaction Report</option>
                                    <option value="MANAGEMENT">Management Summary</option>
                                    <option value="CUSTOM">Custom Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Output Format</label>
                                <select class="form-control" name="format" required>
                                    <option value="PDF">PDF</option>
                                    <option value="EXCEL">Excel</option>
                                    <option value="CSV">CSV</option>
                                    <option value="JSON">JSON</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="start_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" name="end_date" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Report Title</label>
                        <input type="text" class="form-control" name="title" placeholder="Custom report title...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Filters</label>
                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-control" name="risk_level">
                                    <option value="">All Risk Levels</option>
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" name="alert_type">
                                    <option value="">All Alert Types</option>
                                    <option value="SANCTIONS_HIT">Sanctions Hit</option>
                                    <option value="ML_ANOMALY">ML Anomaly</option>
                                    <option value="AML_UNUSUAL_INCOMING">Unusual Incoming</option>
                                    <option value="CROSS_CURRENCY">Cross Currency</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" name="currency">
                                    <option value="">All Currencies</option>
                                    <option value="USD">USD</option>
                                    <option value="ZWL">ZWL</option>
                                    <option value="ZAR">ZAR</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_charts" id="includeCharts" checked>
                        <label class="form-check-label" for="includeCharts">
                            Include Charts and Visualizations
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="include_details" id="includeDetails" checked>
                        <label class="form-check-label" for="includeDetails">
                            Include Detailed Transaction Data
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-download me-2"></i>Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="reportsLoader" class="d-none">
    <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading reports...</span>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-danger" role="alert">
    You must be logged in to view this page. Please <a href="/admin/login">login</a>.
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
/**
 * Reports Management JavaScript
 */
class ReportsManagement {
    constructor() {
        this.charts = {};
        this.reportData = {};
        this.init();
    }

    getAuthHeaders() {
        const token = localStorage.getItem('admin_token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }
    
    async init() {
        this.setupEventListeners();
        this.initializeCharts();
        await this.loadReportData();
        this.updateDashboard();
    }
    
    setupEventListeners() {
        // Filter change handlers
        ['reportPeriod', 'reportType', 'riskLevelFilter', 'currencyFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => this.updateReports());
        });
        
        // Date range handler
        document.getElementById('reportPeriod').addEventListener('change', (e) => {
            const customRange = document.getElementById('customReportRange');
            customRange.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });
        
        // Button handlers
        document.getElementById('refreshReports').addEventListener('click', () => this.loadReportData());
        document.getElementById('generateSAR').addEventListener('click', () => this.showGenerateReportModal('SAR'));
        document.getElementById('generateCTR').addEventListener('click', () => this.showGenerateReportModal('CTR'));
        document.getElementById('generateManagementReport').addEventListener('click', () => this.showGenerateReportModal('MANAGEMENT'));
        document.getElementById('generateCustomReport').addEventListener('click', () => this.showGenerateReportModal('CUSTOM'));
        
        // Form handlers
        document.getElementById('generateReportForm').addEventListener('submit', (e) => this.handleGenerateReport(e));
        
        // Tab change handler
        const tabElements = document.querySelectorAll('#reportTabs button[data-bs-toggle="tab"]');
        tabElements.forEach(tab => {
            tab.addEventListener('shown.bs.tab', (event) => {
                const targetPane = event.target.getAttribute('data-bs-target');
                this.loadTabData(targetPane.replace('#', '').replace('-', '_'));
            });
        });
    }
    
    async loadReportData() {
        try {
            this.showLoading(true);
            
            // Load executive summary
            const summaryResponse = await fetch('/api/reports/executive-summary', { headers: this.getAuthHeaders() });
            if (summaryResponse.status === 401) { window.location.href = '/admin/login'; return; }
            if (summaryResponse.ok) {
                const summary = await summaryResponse.json();
                this.updateExecutiveSummary(summary);
            }
            
            // Load chart data
            const chartsResponse = await fetch('/api/reports/charts-data', { headers: this.getAuthHeaders() });
            if (chartsResponse.status === 401) { window.location.href = '/admin/login'; return; }
            if (chartsResponse.ok) {
                const chartsData = await chartsResponse.json();
                this.updateCharts(chartsData);
            }
            
            // Load detailed report data
            await this.loadTabData('alerts_report');
            
        } catch (error) {
            console.error('Error loading report data:', error);
            AMLBase.showToast('Failed to load report data', 'danger');
        } finally {
            this.showLoading(false);
        }
    }
    
    updateExecutiveSummary(data) {
        // Update summary metrics
        document.getElementById('totalTransactions').textContent = data.total_transactions.toLocaleString();
        document.getElementById('totalVolume').textContent = AMLBase.formatCurrency(data.total_volume);
        document.getElementById('alertsGenerated').textContent = data.alerts_generated.toLocaleString();
        document.getElementById('casesOpened').textContent = data.cases_opened.toLocaleString();
        document.getElementById('sarsFiledCount').textContent = data.sars_filed.toLocaleString();
        document.getElementById('complianceScore').textContent = data.compliance_score.toFixed(1) + '%';
        
        // Update change indicators
        this.updateChangeIndicator('transactionsChange', data.transactions_change);
        this.updateChangeIndicator('volumeChange', data.volume_change);
        this.updateChangeIndicator('alertsChange', data.alerts_change);
        this.updateChangeIndicator('casesChange', data.cases_change);
        this.updateChangeIndicator('sarsChange', data.sars_change);
        this.updateChangeIndicator('complianceChange', data.compliance_change);
    }
    
    updateChangeIndicator(elementId, change) {
        const element = document.getElementById(elementId);
        if (element) {
            const isPositive = change >= 0;
            element.textContent = (isPositive ? '+' : '') + change.toFixed(1) + '%';
            element.className = `metric-change ${isPositive ? 'change-positive' : 'change-negative'}`;
        }
    }
    
    initializeCharts() {
        this.initVolumeChart();
        this.initAlertDistributionChart();
        this.initRiskTrendsChart();
        this.initChannelAnalysisChart();
        this.initCustomerRiskChart();
    }
    
    initVolumeChart() {
        const ctx = document.getElementById('volumeTrendsChart');
        if (!ctx) return;
        
        this.charts.volumeTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Transaction Volume (USD)',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'High Risk Volume (USD)',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '

<style>
/* Reports Specific Styles */
.summary-metric {
    text-align: center;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.summary-metric .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e3a5f;
    margin-bottom: 0.25rem;
}

.summary-metric .metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.summary-metric .metric-change {
    font-size: 0.875rem;
    font-weight: 600;
}

.compliance-metrics {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.compliance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.compliance-label {
    font-weight: 600;
    margin-right: 1rem;
}

.compliance-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
}

.compliance-value .progress {
    flex: 1;
    height: 0.5rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

@media (max-width: 768px) {
    .summary-metric {
        margin-bottom: 1rem;
    }
    
    .compliance-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .compliance-value {
        width: 100%;
    }
}
</style>
{% endblock %}
 + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    initAlertDistributionChart() {
        const ctx = document.getElementById('alertDistributionChart');
        if (!ctx) return;
        
        this.charts.alertDistribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#dc3545', '#fd7e14', '#ffc107', '#28a745',
                        '#17a2b8', '#6f42c1', '#e83e8c', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    initRiskTrendsChart() {
        const ctx = document.getElementById('riskTrendsChart');
        if (!ctx) return;
        
        this.charts.riskTrends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Critical Risk',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    fill: true
                }, {
                    label: 'High Risk',
                    data: [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.2)',
                    fill: true
                }, {
                    label: 'Medium Risk',
                    data: [],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    initChannelAnalysisChart() {
        const ctx = document.getElementById('channelAnalysisChart');
        if (!ctx) return;
        
        this.charts.channelAnalysis = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#dc3545',
                        '#17a2b8', '#6f42c1', '#fd7e14', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    initCustomerRiskChart() {
        const ctx = document.getElementById('customerRiskChart');
        if (!ctx) return;
        
        this.charts.customerRisk = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Customer Count',
                    data: [],
                    backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    updateCharts(data) {
        // Update volume trends chart
        if (this.charts.volumeTrends && data.volume_trends) {
            this.charts.volumeTrends.data.labels = data.volume_trends.labels;
            this.charts.volumeTrends.data.datasets[0].data = data.volume_trends.total_volume;
            this.charts.volumeTrends.data.datasets[1].data = data.volume_trends.high_risk_volume;
            this.charts.volumeTrends.update();
        }
        
        // Update alert distribution chart
        if (this.charts.alertDistribution && data.alert_distribution) {
            this.charts.alertDistribution.data.labels = data.alert_distribution.labels;
            this.charts.alertDistribution.data.datasets[0].data = data.alert_distribution.data;
            this.charts.alertDistribution.update();
        }
        
        // Update risk trends chart
        if (this.charts.riskTrends && data.risk_trends) {
            this.charts.riskTrends.data.labels = data.risk_trends.labels;
            this.charts.riskTrends.data.datasets[0].data = data.risk_trends.critical;
            this.charts.riskTrends.data.datasets[1].data = data.risk_trends.high;
            this.charts.riskTrends.data.datasets[2].data = data.risk_trends.medium;
            this.charts.riskTrends.update();
        }
        
        // Update channel analysis chart
        if (this.charts.channelAnalysis && data.channel_analysis) {
            this.charts.channelAnalysis.data.labels = data.channel_analysis.labels;
            this.charts.channelAnalysis.data.datasets[0].data = data.channel_analysis.data;
            this.charts.channelAnalysis.update();
        }
        
        // Update customer risk chart
        if (this.charts.customerRisk && data.customer_risk) {
            this.charts.customerRisk.data.labels = data.customer_risk.labels;
            this.charts.customerRisk.data.datasets[0].data = data.customer_risk.data;
            this.charts.customerRisk.update();
        }
    }
    
    async loadTabData(tabName) {
        try {
            const response = await fetch(`/api/reports/${tabName}`, { headers: this.getAuthHeaders() });
            if (response.status === 401) { window.location.href = '/admin/login'; return; }
            if (!response.ok) throw new Error(`Failed to load ${tabName} data`);
            
            const data = await response.json();
            this.updateTabContent(tabName, data);
            
        } catch (error) {
            console.error(`Error loading ${tabName} data:`, error);
        }
    }
    
    updateTabContent(tabName, data) {
        switch (tabName) {
            case 'alerts_report':
                this.updateAlertsReport(data);
                break;
            case 'transactions_report':
                this.updateTransactionsReport(data);
                break;
            case 'customers_report':
                this.updateCustomersReport(data);
                break;
            case 'compliance_report':
                this.updateComplianceReport(data);
                break;
        }
    }
    
    updateAlertsReport(data) {
        // Update alert summary table
        const alertSummaryTable = document.querySelector('#alertSummaryTable tbody');
        if (alertSummaryTable && data.alert_summary) {
            alertSummaryTable.innerHTML = '';
            data.alert_summary.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.alert_type}</td>
                    <td>${row.count}</td>
                    <td>${(row.avg_risk_score * 100).toFixed(1)}%</td>
                    <td>${row.resolution_rate.toFixed(1)}%</td>
                `;
                alertSummaryTable.appendChild(tr);
            });
        }
        
        // Update top risk customers table
        const topRiskTable = document.querySelector('#topRiskCustomersTable tbody');
        if (topRiskTable && data.top_risk_customers) {
            topRiskTable.innerHTML = '';
            data.top_risk_customers.forEach(customer => {
                const tr = document.createElement('tr');
                const riskLevel = AMLBase.getRiskLevel(customer.max_risk_score);
                tr.innerHTML = `
                    <td>${customer.customer_id}</td>
                    <td>${customer.alert_count}</td>
                    <td><span class="risk-score risk-${riskLevel}">${(customer.max_risk_score * 100).toFixed(0)}%</span></td>
                    <td><span class="status-badge status-${customer.risk_rating.toLowerCase()}">${customer.risk_rating}</span></td>
                `;
                topRiskTable.appendChild(tr);
            });
        }
    }
    
    updateTransactionsReport(data) {
        const table = document.querySelector('#highValueTransactionsTable tbody');
        if (table && data.high_value_transactions) {
            table.innerHTML = '';
            data.high_value_transactions.forEach(txn => {
                const tr = document.createElement('tr');
                const riskLevel = AMLBase.getRiskLevel(txn.risk_score);
                tr.innerHTML = `
                    <td>${txn.transaction_id}</td>
                    <td>${txn.customer_id}</td>
                    <td>${AMLBase.formatCurrency(txn.amount)} ${txn.currency}</td>
                    <td>${txn.currency}</td>
                    <td>${txn.channel}</td>
                    <td><span class="risk-score risk-${riskLevel}">${(txn.risk_score * 100).toFixed(0)}%</span></td>
                    <td>${AMLBase.formatDate(txn.created_at)}</td>
                `;
                table.appendChild(tr);
            });
        }
    }
    
    updateCustomersReport(data) {
        const table = document.querySelector('#pepCustomersTable tbody');
        if (table && data.pep_customers) {
            table.innerHTML = '';
            data.pep_customers.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${customer.customer_id}</td>
                    <td>${customer.full_name}</td>
                    <td><span class="status-badge status-${customer.risk_rating.toLowerCase()}">${customer.risk_rating}</span></td>
                    <td>${customer.is_pep ? '<span class="badge bg-warning">PEP</span>' : 'No'}</td>
                    <td>${customer.last_review_date ? AMLBase.formatDate(customer.last_review_date) : 'Never'}</td>
                `;
                table.appendChild(tr);
            });
        }
    }
    
    updateComplianceReport(data) {
        if (data.compliance_metrics) {
            const metrics = data.compliance_metrics;
            
            // Update SLA compliance
            this.updateProgressBar('alertResponseProgress', 'alertResponsePercentage', metrics.alert_response_sla);
            this.updateProgressBar('caseResolutionProgress', 'caseResolutionPercentage', metrics.case_resolution_sla);
            this.updateProgressBar('sarFilingProgress', 'sarFilingPercentage', metrics.sar_filing_sla);
            
            // Update regulatory metrics
            document.getElementById('totalSARs').textContent = metrics.total_sars;
            document.getElementById('totalCTRs').textContent = metrics.total_ctrs;
            document.getElementById('sanctionsScreeningCoverage').textContent = metrics.sanctions_coverage + '%';
            document.getElementById('falsePositiveRate').textContent = metrics.false_positive_rate.toFixed(1) + '%';
            document.getElementById('alertInvestigationRate').textContent = metrics.investigation_rate.toFixed(1) + '%';
            document.getElementById('systemUptime').textContent = metrics.system_uptime.toFixed(2) + '%';
        }
    }
    
    updateProgressBar(progressId, percentageId, value) {
        const progressBar = document.getElementById(progressId);
        const percentageSpan = document.getElementById(percentageId);
        
        if (progressBar) {
            progressBar.style.width = value + '%';
            
            // Update color based on performance
            progressBar.className = 'progress-bar';
            if (value >= 90) {
                progressBar.classList.add('bg-success');
            } else if (value >= 70) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-danger');
            }
        }
        
        if (percentageSpan) {
            percentageSpan.textContent = value.toFixed(1) + '%';
        }
    }
    
    showGenerateReportModal(reportType) {
        const modal = new bootstrap.Modal(document.getElementById('generateReportModal'));
        const form = document.getElementById('generateReportForm');
        
        // Pre-select report type
        form.querySelector('[name="report_type"]').value = reportType;
        
        // Set default dates
        const endDate = new Date();
        const startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - 30);
        
        form.querySelector('[name="end_date"]').value = endDate.toISOString().split('T')[0];
        form.querySelector('[name="start_date"]').value = startDate.toISOString().split('T')[0];
        
        modal.show();
    }
    
    async handleGenerateReport(e) {
        e.preventDefault();
        
        try {
            const formData = new FormData(e.target);
            const reportData = Object.fromEntries(formData);
            
            this.showLoading(true);
            
            const response = await fetch('/api/reports/generate', {
                method: 'POST',
                headers: this.getAuthHeaders(),
                body: JSON.stringify(reportData)
            });
            if (response.status === 401) { window.location.href = '/admin/login'; return; }
            if (!response.ok) throw new Error('Failed to generate report');
            
            // Download the report
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportData.report_type}_report_${new Date().toISOString().split('T')[0]}.${reportData.format.toLowerCase()}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            AMLBase.showToast('Report generated successfully', 'success');
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('generateReportModal')).hide();
            
        } catch (error) {
            console.error('Error generating report:', error);
            AMLBase.showToast('Failed to generate report', 'danger');
        } finally {
            this.showLoading(false);
        }
    }
    
    updateReports() {
        // Reload data based on current filters
        this.loadReportData();
    }
    
    showLoading(show) {
        const loader = document.getElementById('reportsLoader');
        if (loader) {
            loader.classList.toggle('d-none', !show);
        }
    }
}

// Initialize reports management when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.reportsManagement = new ReportsManagement();
});
</script>

<style>
/* Reports Specific Styles */
.summary-metric {
    text-align: center;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.summary-metric .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e3a5f;
    margin-bottom: 0.25rem;
}

.summary-metric .metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.summary-metric .metric-change {
    font-size: 0.875rem;
    font-weight: 600;
}

.compliance-metrics {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.compliance-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.compliance-label {
    font-weight: 600;
    margin-right: 1rem;
}

.compliance-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
}

.compliance-value .progress {
    flex: 1;
    height: 0.5rem;
}

.chart-container {
    position: relative;
    height: 300px;
}

@media (max-width: 768px) {
    .summary-metric {
        margin-bottom: 1rem;
    }
    
    .compliance-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .compliance-value {
        width: 100%;
    }
}
</style>
{% endblock %}
