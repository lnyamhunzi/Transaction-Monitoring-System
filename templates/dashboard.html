{% extends "base.html" %}

{% block title %}Banking AML System{% endblock %}

{% block page_title %}AML Dashboard{% endblock %}


{% block content %}
<!-- Dashboard Metrics -->
<div class="metrics-grid">
    <div class="metric-card">
        <div class="metric-value" id="today-transactions">{{ today_transactions }}</div>
        <div class="metric-label">Today's Transactions</div>
        <div class="metric-change change-positive" id="transactions-change">{{ transactions_change }}%</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value" id="open-alerts">{{ open_alerts }}</div>
        <div class="metric-label">Open Alerts</div>
        <div class="metric-change change-negative" id="alerts-change">{{ alerts_change }}%</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value" id="high-risk-alerts">{{ high_risk_alerts }}</div>
        <div class="metric-label">High Risk Alerts</div>
        <div class="metric-change change-positive" id="high-risk-change">N/A</div>
    </div>
    
    <div class="metric-card">
        <div class="metric-value" id="cases-opened-today">{{ cases_opened_today }}</div>
        <div class="metric-label">Cases Opened Today</div>
        <div class="metric-change change-positive" id="cases-change">{{ cases_change }}</div>
    </div>
</div>

<!-- Control Panel -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Real-time Monitoring
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" id="refreshDashboard">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline-success" id="exportAlerts">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <a href="/monitoring/real-time" class="btn btn-primary">
                            <i class="fas fa-eye"></i> Real-time View
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Alert Status</label>
                            <select class="form-control" id="alertStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="OPEN">Open</option>
                                <option value="INVESTIGATING">Investigating</option>
                                <option value="CLOSED">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Alert Type</label>
                            <select class="form-control" id="alertTypeFilter">
                                <option value="">All Types</option>
                                <option value="AML_STAFF_POSTING">Staff Posting</option>
                                <option value="AML_UNUSUAL_INCOMING">Unusual Incoming</option>
                                <option value="SWIFT_UNUSUAL">SWIFT Unusual</option>
                                <option value="CROSS_CURRENCY">Cross Currency</option>
                                <option value="SANCTIONS_HIT">Sanctions Hit</option>
                                <option value="ML_ANOMALY">ML Anomaly</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Time Range</label>
                            <select class="form-control" id="timeRangeFilter">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Risk Level</label>
                            <select class="form-control" id="riskLevelFilter">
                                <option value="">All Risk Levels</option>
                                <option value="low">Low (0-40%)</option>
                                <option value="medium">Medium (40-70%)</option>
                                <option value="high">High (70-90%)</option>
                                <option value="critical">Critical (90-100%)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Risk Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Alert Trends
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="alertTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Transaction Volume
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="transactionVolumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Alerts Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Recent Alerts
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="refreshAlerts">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a href="/alerts" class="btn btn-sm btn-primary">
                            View All Alerts
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table table-striped table-hover" id="alertsTable">
                        <thead>
                            <tr>
                                <th>Alert Details</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions Table -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        Recent Transactions
                    </h5>
                    <a href="/staff/monitoring/transactions" class="btn btn-sm btn-primary">
                        View All Transactions
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="transactionSearchInput" placeholder="Search by customer, account, or transaction ID">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="transactionTypeFilter">
                            <option value="all">All Types</option>
                            <option value="Deposit">Deposit</option>
                            <option value="Withdrawal">Withdrawal</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Payment">Payment</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="transactionStatusFilter">
                            <option value="all">All Statuses</option>
                            <option value="Completed">Completed</option>
                            <option value="Pending">Pending</option>
                            <option value="Failed">Failed</option>
                            <option value="Flagged">Flagged</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="transactionDateFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="applyTransactionFiltersBtn">Search</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="dashboardLoader" class="d-none">
    <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading dashboard...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Case Management JavaScript (needed for Create Case modal) -->
<script src="/static/js/case-management.js"></script>

<!-- Dashboard JavaScript -->
<script src="/static/js/dashboard.js"></script>

<script>
// Dashboard-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTables for alerts table
    const alertsTable = $('#alertsTable').DataTable({
        pageLength: 10,
        responsive: true,
        order: [[0, 'desc']], // Sort by alert details (newest first)
        columnDefs: [
            {
                targets: [5], // Actions column
                orderable: false,
                searchable: false
            }
        ],
        language: {
            emptyTable: "No alerts to display",
            info: "Showing _START_ to _END_ of _Total_ alerts",
            infoEmpty: "No alerts available",
            search: "Search alerts:",
            lengthMenu: "Show _MENU_ alerts per page"
        }
    });
    
    // Store reference globally
    window.alertsDataTable = alertsTable;
});

// Auto-refresh dashboard every 30 seconds
setInterval(function() {
    if (window.amlDashboard && window.amlDashboard.isConnected) {
        // Only refresh if WebSocket is not connected
        return;
    }
    
    // Refresh dashboard data
    if (window.amlDashboard) {
        window.amlDashboard.loadInitialData();
    }
}, 30000);
</script>
{% endblock %}
